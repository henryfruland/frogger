<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Third Grade Math Frogger</title>
  <style>
    body { text-align:center; font-family:Arial; background:#bde3ff; margin:0; }
    h1 { margin:16px 0 6px; }
    canvas { border:3px solid #000; background:#7ec850; display:none; margin: 12px auto; }
    .screen { display:none; margin-top:60px; }
    button { font-size:18px; padding:10px 16px; margin:10px; }
    select { font-size:18px; padding:10px 12px; margin:10px; }

    /* Top HUD buttons */
    #saveWrap { position:fixed; top:12px; right:12px; display:none; text-align:right; }
    #saveBtn { font-size:14px; padding:10px 12px; margin:0; }
    #saveHint { font-size:12px; margin-top:6px; }

    #powerWrap { position:fixed; top:12px; left:12px; display:none; text-align:left; }
    #powerBtn { font-size:14px; padding:10px 12px; margin:0; }
    #diamondLine { font-size:12px; margin-top:6px; }

    #storageWrap { position:fixed; bottom:12px; left:12px; display:none; background:#fff; border:2px solid #333;
      border-radius:10px; padding:8px; width:240px; text-align:left; box-shadow: 0 8px 20px rgba(0,0,0,0.2);}
    #storageTitle { font-weight:bold; margin-bottom:6px; }
    #storageList { font-size:12px; }

    /* Superpowers panel */
    #powerPanel {
      position:fixed; top:60px; left:12px;
      width:280px;
      background:#ffffff;
      border:2px solid #333;
      border-radius:10px;
      padding:10px;
      display:none;
      text-align:left;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    }
    #powerPanel h3 { margin:6px 0 10px; }
    .upgrade {
      border:1px solid #ddd;
      border-radius:10px;
      padding:10px;
      margin:8px 0;
      background:#f8f8f8;
    }
    .upgradeTitle { font-weight:bold; }
    .upgradeDesc { font-size:12px; margin-top:4px; }
    .upgradeRow { display:flex; justify-content:space-between; align-items:center; margin-top:8px; gap:8px; }
    .smallBtn { font-size:12px; padding:8px 10px; margin:0; }
    .cost { font-size:12px; }

    .fracOption { display:inline-block; border:2px solid #333; background:#fff; padding:10px; cursor:pointer; }
    svg { width:120px; height:120px; }
    #mathA { font-size:20px; padding:10px; width:140px; text-align:center; }
  </style>
</head>
<body>
  <h1>Third Grade Math Frogger</h1>

  <div id="start" class="screen" style="display:block;">
    <select id="diff">
      <option>Easy</option>
      <option>Medium</option>
      <option>Hard</option>
      <option>Very Hard</option>
    </select><br>
    <button id="startBtn">START</button>
  </div>

  <div id="math" class="screen">
    <h2 id="mathQ"></h2>
    <input id="mathA" inputmode="numeric" />
    <br>
    <button id="mathSubmit">Submit</button>
  </div>

  <div id="frac" class="screen">
    <h2 id="fracQ"></h2>
    <div id="fracChoices"></div>
  </div>

  <!-- top-left -->
  <div id="powerWrap">
    <button id="powerBtn">Superpowers</button>
    <div id="diamondLine">ðŸ’Ž 0</div>
  </div>

  <div id="powerPanel" role="dialog" aria-label="Superpowers">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3 style="margin:0;">Superpowers</h3>
      <button id="closePower" class="smallBtn">Close</button>
    </div>
    <div style="font-size:12px; margin:6px 0 10px;">Buy powers â†’ they go to <b>Storage</b> (bottom-left). Click in Storage to use.</div>

    <div class="upgrade" data-up="lifePlus">
      <div class="upgradeTitle">+1 Life (upgrade)</div>
      <div class="upgradeDesc">Tier 1 = 3 lives, Tier 2 = 4 lives, Tier 3 = 5 lives.</div>
      <div class="upgradeRow">
        <div class="cost"><span class="tierText"></span> â€¢ Cost: <span class="costVal"></span> ðŸ’Ž</div>
        <button class="smallBtn buyBtn">Buy</button>
      </div>
    </div>

    <div class="upgrade" data-up="moreHold">
      <div class="upgradeTitle">Hold More Save Markers (upgrade)</div>
      <div class="upgradeDesc">Tier 1 = 5 max, Tier 2 = 7 max, Tier 3 = 9 max.</div>
      <div class="upgradeRow">
        <div class="cost"><span class="tierText"></span> â€¢ Cost: <span class="costVal"></span> ðŸ’Ž</div>
        <button class="smallBtn buyBtn">Buy</button>
      </div>
    </div>

    <div class="upgrade" data-up="slowerCars">
      <div class="upgradeTitle">Slow Cars (one-life)</div>
      <div class="upgradeDesc">Works until you die once. Then you must re-buy.</div>
      <div class="upgradeRow">
        <div class="cost">Cost: <span class="costVal"></span> ðŸ’Ž</div>
        <button class="smallBtn buyBtn">Buy</button>
      </div>
    </div>

    <div class="upgrade" data-up="shield">
      <div class="upgradeTitle">Shield (1 free hit) (one-life)</div>
      <div class="upgradeDesc">First hit is free. After you die once, you must re-buy.</div>
      <div class="upgradeRow">
        <div class="cost">Cost: <span class="costVal"></span> ðŸ’Ž</div>
        <button class="smallBtn buyBtn">Buy</button>
      </div>
    </div>

    <div class="upgrade" data-up="bonusDiamonds">
      <div class="upgradeTitle">Bonus Diamonds (upgrade)</div>
      <div class="upgradeDesc">Tier 1 = +25 each level, Tier 2 = +50, Tier 3 = +75.</div>
      <div class="upgradeRow">
        <div class="cost"><span class="tierText"></span> â€¢ Cost: <span class="costVal"></span> ðŸ’Ž</div>
        <button class="smallBtn buyBtn">Buy</button>
      </div>
    </div>

  </div>

  <!-- bottom-left storage -->
  <div id="storageWrap">
    <div id="storageTitle">Storage</div>
    <div id="storageList"></div>
  </div>

  <!-- top-right -->
  <div id="saveWrap">
    <button id="saveBtn">Save Marker</button>
    <div id="saveHint"></div>
  </div>

  <canvas id="game" width="600" height="600"></canvas>

<script>
/* ---------- assets ---------- */
const frogImg = new Image();
frogImg.src = "data:image/jpeg;base64,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";

/* ---------- DOM ---------- */
const c = document.getElementById('game');
const ctx = c.getContext('2d');

const startScreen = document.getElementById('start');
const mathScreen = document.getElementById('math');
const fracScreen = document.getElementById('frac');

const saveWrap = document.getElementById('saveWrap');
const saveBtn = document.getElementById('saveBtn');
const saveHint = document.getElementById('saveHint');

const powerWrap = document.getElementById('powerWrap');
const powerBtn = document.getElementById('powerBtn');
const diamondLine = document.getElementById('diamondLine');
const powerPanel = document.getElementById('powerPanel');
const closePower = document.getElementById('closePower');

const storageWrap = document.getElementById('storageWrap');
const storageList = document.getElementById('storageList');

const startBtn = document.getElementById('startBtn');
const diffSel = document.getElementById('diff');

const mathQ = document.getElementById('mathQ');
const mathA = document.getElementById('mathA');
const mathSubmit = document.getElementById('mathSubmit');

const fracQ = document.getElementById('fracQ');
const fracChoices = document.getElementById('fracChoices');

/* ---------- game state ---------- */
let level = 1;
const MAX_LEVEL = 5;
let baseSpeed = 2;
let speed = 2;

let maxLives = 2;
let lives = 2;

let runShield = false; // one-life power
let runSlow = false;   // one-life power

let playing = false;
let expectingMath = false;
let expectingFrac = false;

let player = { x: 280, y: 560, s: 40 };
let cars = [];        // horizontal cars for levels 1-4
let sideCars = [];    // vertical side cars for level 5

let answerNumber = 0; // math answer
let answerFrac = "";  // correct fraction string "n/d"

/* ---------- diamonds & upgrade tiers ---------- */
const LS_DIAMONDS = "tgmf_diamonds";
const LS_TIER_LIFE = "tgmf_tier_life";       // 0..3
const LS_TIER_HOLD = "tgmf_tier_hold";       // 0..3
const LS_TIER_BONUS = "tgmf_tier_bonus";     // 0..3
const MAX_TIER = 3;

function getDiamonds(){ return parseInt(localStorage.getItem(LS_DIAMONDS) || "0", 10); }
function setDiamonds(v){ localStorage.setItem(LS_DIAMONDS, String(Math.max(0, v))); }

function getTier(key){ return Math.max(0, Math.min(MAX_TIER, parseInt(localStorage.getItem(key) || "0", 10))); }
function setTier(key, v){ localStorage.setItem(key, String(Math.max(0, Math.min(MAX_TIER, v)))); }

function updateDiamondUI(){ diamondLine.textContent = `ðŸ’Ž ${getDiamonds()}`; }

function tierText(cur){ return cur >= MAX_TIER ? `Tier ${cur} (MAX)` : `Tier ${cur} â†’ ${cur+1}`; }

/* Costs you requested (Tier 1 costs). Higher tiers cost more. */
const baseCosts = {
  lifePlus: 700,
  moreHold: 500,
  slowerCars: 400,
  shield: 200,
  bonusDiamonds: 150
};

function nextCostFor(up){
  if(up === 'lifePlus') return baseCosts.lifePlus * (getTier(LS_TIER_LIFE)+1);
  if(up === 'moreHold') return baseCosts.moreHold * (getTier(LS_TIER_HOLD)+1);
  if(up === 'bonusDiamonds') return baseCosts.bonusDiamonds * (getTier(LS_TIER_BONUS)+1);
  return baseCosts[up];
}

function isMaxed(up){
  if(up === 'lifePlus') return getTier(LS_TIER_LIFE) >= MAX_TIER;
  if(up === 'moreHold') return getTier(LS_TIER_HOLD) >= MAX_TIER;
  if(up === 'bonusDiamonds') return getTier(LS_TIER_BONUS) >= MAX_TIER;
  return false;
}

function applyUpgradesForRun(){
  const lifeTier = getTier(LS_TIER_LIFE); // 0..3
  maxLives = 2 + lifeTier;               // 2,3,4,5
  lives = maxLives;
}

/* ---------- Storage ---------- */
const LS_STORAGE = "tgmf_storage"; // array of strings
function getStorage(){ try{ return JSON.parse(localStorage.getItem(LS_STORAGE)||"[]"); }catch(e){ return []; } }
function setStorage(a){ localStorage.setItem(LS_STORAGE, JSON.stringify(a)); }

function niceName(up){
  if(up==='lifePlus') return '+1 Life (upgrade)';
  if(up==='moreHold') return 'Hold More Markers (upgrade)';
  if(up==='slowerCars') return 'Slow Cars (one-life)';
  if(up==='shield') return 'Shield (one-life)';
  if(up==='bonusDiamonds') return 'Bonus Diamonds (upgrade)';
  return up;
}

function refreshStorage(){
  const arr = getStorage();
  storageList.innerHTML = "";
  if(arr.length===0){ storageList.textContent = "Empty"; return; }

  arr.forEach((up,idx)=>{
    const row = document.createElement('div');
    row.style.display = 'flex';
    row.style.justifyContent = 'space-between';
    row.style.alignItems = 'center';
    row.style.gap = '8px';
    row.style.margin = '6px 0';

    const label = document.createElement('div');
    label.textContent = niceName(up);
    label.style.flex = '1';
    label.style.fontSize = '12px';

    const b = document.createElement('button');
    b.className = 'smallBtn';
    b.textContent = "Use";
    b.onclick = ()=>{
      // Tier upgrades: increase tier by 1 (up to MAX_TIER)
      if(up==='lifePlus') setTier(LS_TIER_LIFE, getTier(LS_TIER_LIFE)+1);
      if(up==='moreHold') setTier(LS_TIER_HOLD, getTier(LS_TIER_HOLD)+1);
      if(up==='bonusDiamonds') setTier(LS_TIER_BONUS, getTier(LS_TIER_BONUS)+1);

      // One-life upgrades for this run only
      if(up==='shield') runShield = true;
      if(up==='slowerCars') runSlow = true;

      const n = getStorage(); n.splice(idx,1); setStorage(n);
      refreshStorage();
      updatePowerPanelButtons();
      alert("Activated!");
    };

    row.appendChild(label);
    row.appendChild(b);
    storageList.appendChild(row);
  });
}

/* ---------- Superpowers Panel ---------- */
function showPowerPanel(show){ powerPanel.style.display = show ? 'block' : 'none'; updatePowerPanelButtons(); }

function updatePowerPanelButtons(){
  updateDiamondUI();

  document.querySelectorAll('.upgrade').forEach(card => {
    const up = card.getAttribute('data-up');
    const costSpan = card.querySelector('.costVal');
    const tierSpan = card.querySelector('.tierText');
    const btn = card.querySelector('.buyBtn');

    const cost = nextCostFor(up);
    costSpan.textContent = cost;

    if(tierSpan){
      if(up==='lifePlus') tierSpan.textContent = tierText(getTier(LS_TIER_LIFE));
      if(up==='moreHold') tierSpan.textContent = tierText(getTier(LS_TIER_HOLD));
      if(up==='bonusDiamonds') tierSpan.textContent = tierText(getTier(LS_TIER_BONUS));
    }

    if(isMaxed(up)){
      btn.textContent = "MAX";
      btn.disabled = true;
    } else {
      btn.textContent = "Buy";
      btn.disabled = getDiamonds() < cost;
    }
  });
}

function buyToStorage(up){
  const cost = nextCostFor(up);
  if(getDiamonds() < cost) return;
  if(isMaxed(up)) return;

  setDiamonds(getDiamonds() - cost);
  const arr = getStorage();
  arr.push(up);            // ALWAYS goes to storage
  setStorage(arr);
  refreshStorage();
  updatePowerPanelButtons();
  updateDiamondUI();
}

document.querySelectorAll('.upgrade .buyBtn').forEach(btn => {
  btn.addEventListener('click', (e) => {
    const up = e.target.closest('.upgrade').getAttribute('data-up');
    buyToStorage(up);
  });
});

powerBtn.addEventListener('click', () => showPowerPanel(powerPanel.style.display !== 'block'));
closePower.addEventListener('click', () => showPowerPanel(false));

/* ---------- Save marker stock ---------- */
const LS_LAST_USE = "tgmf_last_save_use";
const LS_MARKER_STOCK = "tgmf_marker_stock";
const LS_SAVED_LEVEL = "tgmf_saved_level";
const LS_CHECKPOINT_ACTIVE = "tgmf_checkpoint_active";

function nowMs(){ return Date.now(); }
function getLastUse(){ return parseInt(localStorage.getItem(LS_LAST_USE) || "0", 10); }
function setLastUse(ms){ localStorage.setItem(LS_LAST_USE, String(ms)); }
function getSavedLevel(){ return parseInt(localStorage.getItem(LS_SAVED_LEVEL) || "0", 10); }
function setSavedLevel(lv){ localStorage.setItem(LS_SAVED_LEVEL, String(lv)); }
function getCheckpointActive(){ return (localStorage.getItem(LS_CHECKPOINT_ACTIVE) || "0") === "1"; }
function setCheckpointActive(v){ localStorage.setItem(LS_CHECKPOINT_ACTIVE, v ? "1" : "0"); }

function getMaxMarkers(){
  // Tiered: base 3, then +2 per tier: 3,5,7,9
  return 3 + 2*getTier(LS_TIER_HOLD);
}

function getStock(){ return parseInt(localStorage.getItem(LS_MARKER_STOCK) || String(getMaxMarkers()), 10); }
function setStock(v){ localStorage.setItem(LS_MARKER_STOCK, String(Math.max(0, Math.min(getMaxMarkers(), v)))); }

function tickStock(){
  const last = getLastUse();
  if(last===0) return;
  const elapsed = nowMs() - last;
  const gained = Math.floor(elapsed / (20*60*1000));
  if(gained>0){
    setLastUse(last + gained*(20*60*1000));
    setStock(Math.min(getMaxMarkers(), getStock() + gained));
  }
}

function saveAvailable(){ tickStock(); return getStock() > 0; }

function updateSaveUI(){
  tickStock();
  const maxM = getMaxMarkers();
  const stock = Math.min(getStock(), maxM);
  setStock(stock);

  if(saveAvailable()){
    saveBtn.disabled = false;
    saveHint.textContent = `Markers: ${stock} / ${maxM}`;
  } else {
    saveBtn.disabled = true;
    const remaining = Math.max(0, 20*60*1000 - (nowMs() - getLastUse()));
    const mins = Math.floor(remaining/60000);
    const secs = Math.floor((remaining%60000)/1000);
    saveHint.textContent = `Markers: 0 / ${maxM} â€¢ Next in ${mins}:${String(secs).padStart(2,'0')}`;
  }
}

saveBtn.addEventListener('click', () => {
  tickStock();
  if(getStock()<=0) return;

  setSavedLevel(level);
  setCheckpointActive(true);

  setStock(getStock()-1);
  if(getLastUse()===0) setLastUse(nowMs());

  updateSaveUI();
  alert(`Save marker used! If you lose ALL lives, you'll come back to Level ${level} once.`);
});

/* ---------- screens ---------- */
function showScreen(which){
  startScreen.style.display = 'none';
  mathScreen.style.display = 'none';
  fracScreen.style.display = 'none';
  c.style.display = 'none';
  saveWrap.style.display = 'none';
  powerWrap.style.display = 'none';
  storageWrap.style.display = 'none';
  showPowerPanel(false);

  if(which === 'start') startScreen.style.display = 'block';
  if(which === 'math') mathScreen.style.display = 'block';
  if(which === 'frac') fracScreen.style.display = 'block';
  if(which === 'game'){
    c.style.display = 'block';
    saveWrap.style.display = 'block';
    powerWrap.style.display = 'block';
    storageWrap.style.display = 'block';
    refreshStorage();
    updateSaveUI();
    updateDiamondUI();
  }
}

/* ---------- setup ---------- */
function setDifficulty(){
  const d = diffSel.value;
  baseSpeed = (d === "Easy") ? 2 : (d === "Medium") ? 3 : (d === "Hard") ? 4 : 6;
}

function resetPlayer(){ player.x = 280; player.y = 560; }

function makeCars(){
  cars = [];
  const count = 5 + level * 2;
  for(let i=0;i<count;i++){
    cars.push({
      x: Math.random()*600,
      y: 110 + (i%5)*80,
      w: 80,
      h: 30,
      dx: (Math.random()>.5?1:-1) * speed
    });
  }
}

function makeSideCars(){
  sideCars = [];
  const countEachSide = 3;
  const leftX = 30;
  const rightX = 600 - 30 - 60;
  for(let i=0;i<countEachSide;i++){
    sideCars.push({ x:leftX,  y:Math.random()*600, w:60, h:32, dy:(Math.random()>.5?1:-1) * (speed*3.8) });
    sideCars.push({ x:rightX, y:Math.random()*600, w:60, h:32, dy:(Math.random()>.5?1:-1) * (speed*3.8) });
  }
}

function buildLevel(){
  // medium ramp + optional one-life slow power
  const slowFactor = runSlow ? 0.85 : 1.0;
  speed = (baseSpeed + (level-1)*0.8) * slowFactor;

  resetPlayer();
  if(level === 5){ makeSideCars(); cars = []; }
  else { sideCars = []; makeCars(); }
}

/* ---------- lives & losing ---------- */
function loseLife(){
  // shield: first hit is free (one-life power)
  if(runShield){
    runShield = false;
    alert("Shield saved you! ðŸ›¡ï¸");
    buildLevel();
    return;
  }

  // if you die once, slow power is gone too
  runSlow = false;

  lives -= 1;
  if(lives > 0){
    alert(`You lost a life! Lives left: ${lives}`);
    buildLevel();
    return;
  }

  // Game over: try save marker once
  if(getCheckpointActive()){
    const sv = getSavedLevel();
    if(sv >= 1 && sv <= MAX_LEVEL){
      level = sv;
      lives = maxLives;
      setCheckpointActive(false);
      buildLevel();
      alert(`Saved! Back to Level ${level} with ${maxLives} lives.`);
      return;
    } else {
      setCheckpointActive(false);
      setSavedLevel(0);
    }
  }

  alert("Game over! Back to Level 1");
  level = 1;
  lives = maxLives;
  setCheckpointActive(false);
  setSavedLevel(0);
  buildLevel();
}

/* ---------- diamonds earning ---------- */
function awardDiamondsForLevelCompleted(completedLevel){
  let gain = 0;
  if(completedLevel === 1) gain = 50;
  if(completedLevel === 2) gain = 100;
  if(completedLevel === 3) gain = 150;
  if(completedLevel === 4) gain = 200;
  if(completedLevel === 5) gain = 500;

  const bonusTier = getTier(LS_TIER_BONUS); // 0..3
  gain += 25 * bonusTier; // 0,25,50,75

  setDiamonds(getDiamonds() + gain);
  updateDiamondUI();
}

/* ---------- start ---------- */
function startGame(){
  setDifficulty();

  applyUpgradesForRun();

  // active checkpoint resets each new run
  setCheckpointActive(false);
  setSavedLevel(0);

  // one-life powers only if you activate them from storage
  runShield = false;
  runSlow = false;

  level = 1;
  buildLevel();
  playing = true;
  expectingMath = false;
  expectingFrac = false;
  showScreen('game');
  requestAnimationFrame(loop);
}

/* ---------- drawing ---------- */
function drawFrog(){ ctx.drawImage(frogImg, player.x, player.y, player.s, player.s); }

function drawCar(ca){
  ctx.fillStyle = '#d32f2f';
  ctx.fillRect(ca.x, ca.y, ca.w, ca.h);
  ctx.fillStyle = '#000';
  ctx.beginPath();
  ctx.arc(ca.x+16, ca.y+ca.h, 6, 0, Math.PI*2);
  ctx.arc(ca.x+ca.w-16, ca.y+ca.h, 6, 0, Math.PI*2);
  ctx.fill();
}

function hitAABB(px,py,pw,ph, rx,ry,rw,rh){ return px < rx+rw && px+pw > rx && py < ry+rh && py+ph > ry; }

function drawHUD(){
  ctx.fillStyle = '#000';
  ctx.font = '18px Arial';
  ctx.fillText(`Level: ${level} / ${MAX_LEVEL}`, 10, 24);
  ctx.fillText(`Lives: ${lives}`, 10, 48);
}

/* ---------- math & fractions ---------- */
function newMathQuestion(){
  const a = 2 + Math.floor(Math.random()*9);
  const b = 2 + Math.floor(Math.random()*9);
  answerNumber = a*b;
  mathQ.textContent = `${a} Ã— ${b}`;
  mathA.value = "";
  setTimeout(()=>mathA.focus(), 0);
}

function pieSVG(num,den){
  const frac = num/den;
  const ang = frac*2*Math.PI;
  const x = 60 + 50*Math.cos(ang - Math.PI/2);
  const y = 60 + 50*Math.sin(ang - Math.PI/2);
  const large = (frac > 0.5) ? 1 : 0;
  return `<svg viewBox="0 0 120 120">
    <circle cx="60" cy="60" r="50" fill="#eee" stroke="#333"/>
    <path d="M60,60 L60,10 A50,50 0 ${large} 1 ${x},${y} Z" fill="#4caf50"/>
  </svg>`;
}

function newFractionRound(){
  const den = [2,4,5,8][Math.floor(Math.random()*4)];
  const num = 1 + Math.floor(Math.random()*(den-1));
  answerFrac = `${num}/${den}`;
  fracQ.textContent = `Click the picture that shows ${answerFrac}`;
  fracChoices.innerHTML = "";

  const opts = Array.from(new Set([answerFrac, `1/${den}`, `${den}/${num}`, `${Math.min(den-1, num+1)}/${den}`]));
  opts.sort(()=>Math.random()-0.5);

  opts.forEach(o=>{
    const parts = o.split('/').map(Number);
    const n = parts[0], d = parts[1];
    const box = document.createElement('div');
    box.className = 'fracOption';
    box.innerHTML = pieSVG(n,d); // picture only
    box.onclick = () => {
      if(o === answerFrac){
        expectingFrac = false;
        awardDiamondsForLevelCompleted(level);

        if(level >= MAX_LEVEL){
          alert("YOU WIN! ðŸ†");
          showScreen('start');
          playing = false;
          return;
        }

        level += 1;
        buildLevel();
        playing = true;
        showScreen('game');
        requestAnimationFrame(loop);
      } else {
        alert("Wrong fraction!");
        expectingFrac = false;
        showScreen('game');
        playing = true;
        loseLife();
      }
    };
    fracChoices.appendChild(box);
  });
}

/* ---------- events ---------- */
startBtn.addEventListener('click', startGame);
startBtn.addEventListener('keydown', (e) => { if(e.key === 'Enter') startGame(); });

mathSubmit.addEventListener('click', () => {
  const val = parseInt(mathA.value || "NaN", 10);
  mathA.value = "";
  if(val === answerNumber){
    expectingMath = false;
    expectingFrac = true;
    showScreen('frac');
    newFractionRound();
  } else {
    alert("Wrong math!");
    expectingMath = false;
    showScreen('game');
    playing = true;
    loseLife();
  }
});

mathA.addEventListener('keydown', (e) => { if(e.key === 'Enter') mathSubmit.click(); });

document.addEventListener('keydown', (e) => {
  if(!playing) return;
  if(expectingMath || expectingFrac) return;

  if(e.key === 'ArrowUp') player.y -= 40;
  if(e.key === 'ArrowDown') player.y += 40;
  if(e.key === 'ArrowLeft') player.x -= 40;
  if(e.key === 'ArrowRight') player.x += 40;

  player.x = Math.max(0, Math.min(600 - player.s, player.x));
  player.y = Math.max(0, Math.min(600 - player.s, player.y));
});

/* ---------- main loop ---------- */
function loop(){
  if(!playing) return;

  ctx.clearRect(0,0,600,600);
  drawHUD();
  drawFrog();

  if(level === 5){
    sideCars.forEach(ca=>{
      drawCar(ca);
      ca.y += ca.dy;
      if(ca.y > 650) ca.y = -80;
      if(ca.y < -80) ca.y = 650;

      if(hitAABB(player.x, player.y, player.s, player.s, ca.x, ca.y, ca.w, ca.h)) loseLife();
    });
  } else {
    cars.forEach(ca=>{
      drawCar(ca);
      ca.x += ca.dx;
      if(ca.x > 650) ca.x = -80;
      if(ca.x < -80) ca.x = 650;

      if(hitAABB(player.x, player.y, player.s, player.s, ca.x, ca.y, ca.w, ca.h)) loseLife();
    });
  }

  if(player.y < 40 && !expectingMath && !expectingFrac){
    playing = false;
    expectingMath = true;
    showScreen('math');
    newMathQuestion();
  }

  updateSaveUI();
  requestAnimationFrame(loop);
}

/* init */
updateDiamondUI();
refreshStorage();
updatePowerPanelButtons();
showScreen('start');
</script>
</body>
</html>
